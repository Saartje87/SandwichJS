/*!
 * SandwichJS v0.0.1
 * https://github.com/Saartje87/SandwichJS
 *
 * Copyright 2013 Niek Saarberg
 * Licensed MIT
 *
 * Build date 2013-12-06 20:18
 */
!function(a,b,c){this[a]=c(b)}("Sandwich",this,function(){"use strict";function a(a,b){return function(){return this.parent=b,a.apply(this,arguments)}}function b(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function c(){return b()+b()+"-"+b()+"-"+b()+"-"+b()+"-"+b()+b()+b()}var d={};PB.Class=function(b,c){var d,e,f,g,h,i,j,k;c||(c=b,b=null),(c.construct||c.constructor.toString().indexOf("Function()")>-1)&&(f=c.construct||c.constructor),b&&(j=b.prototype,f?k=b:f=b),d=f?function(){return k&&(this.parent=k),f.apply(this,arguments)}:function(){},e=d.prototype;for(g in c)c.hasOwnProperty(g)&&"construct"!==g&&(h=c[g],i=b?j[g]:null,i&&"function"==typeof h&&"function"==typeof i&&(h=a(h,i)),e[g]=h);return PB.extend(e,j),d},d.Error={report:function(a){throw new Error(a)}};var e={};d.Module={define:function(a,b,c){c||(c=b,b=null),"string"!=typeof a&&d.Error.report("Sandwich.Module.define::moduleName must be a string"),"function"!=typeof c&&d.Error.report("Sandwich.Module.define::module definition must be function"),e[a]&&d.Error.report("Sandwich.Module.define::module `"+a+"` already declared"),e[a]={dependecies:b,module:c,instance:null}},getInstance:function(a){var b,c=[];return a in e||d.Error.report("Sandwich.Module.getInstance::module `"+a+"` not found"),b=e[a],b.instance?b.instance:(b.dependecies&&b.dependecies.forEach(function(a){c.push(this.getInstance(a))},this),b.instance=b.module.apply(null,c),"function"==typeof b.instance.onStart&&b.instance.onStart(),b.instance)},getModules:function(){return e}};var f=!1;d.Application={rootElement:"body",_modules:{},create:function(a){var b,c=this._modules,e={};if(a||(a={}),f)return d.Error.report("Sandwich.Application.create already initialized");this.rootElement=e.rootElement=PB.$(a.rootElement||this.rootElement);for(b in c)c.hasOwnProperty(b)&&(e[b]=c[b]());return f=!0,e},register:function(a,b){this._modules[a]=b}},d.Module.define("Router",["Route"],function(a){function b(a){var b;"string"!=typeof a&&(a=window.location.hash),a=c(a),(b=e(a))&&b.callback.apply(b.callback,b.params)}function c(a){return a.replace(/^#?\!?/,"").replace(/^\/\/+/g,"/").replace(/^[\/|\s]+|[\/|\s]+$/g,"")}function e(b){for(var c,d,e=a.all(),f=0;f<e.length;f++)if(c=e[f].matches(b)){d=e[f];break}return d?{route:d.route,callback:d.callback,params:c}:!1}return{onStart:function(){if(!("onhashchange"in window))throw new Error("Browser not supported");PB.$(window).on("hashchange",b),PB.ready(b)},navigate:function(a,d){return a=a.replace(window.location.protocol+"//"+window.location.hostname,""),d&&d.silent?b(a,d):(window.location.hash="!"+c(a),void 0)},when:function(b,e){"string"!=typeof b&&d.Error.report("Router.when::First argument must be a string"),"function"!=typeof e&&d.Error.report("Router.when::Second argument must be a function"),b=c(b),a.add(b,e)}}}),d.Application.register("Router",function(){return d.Module.getInstance("Router")}),d.Module.define("Route",function(){function a(a){for(var b="^",c="",d=0,e=a.length;e>d;d++)switch(c=a[d]){case"/":b+="\\/";break;case":":d=skipGroup(d,a),b+="([a-z0-9.\\s_-]+)";break;case"*":d=skipGroup(d,a),b+="(.*)";break;default:b+=c}return b+="$",b=new RegExp(b,"i"),function(a){var c=a.match(b);return c?Array.prototype.slice.call(c,1):null}}var b=[];return{add:function(c,d){b.unshift({route:c,matches:a(c),callback:d})},all:function(){return b}}});var g={};d.Sync={};var h=PB.Class(PB.Observer,{name:null,idAttribute:"id",sync:"RESTful",construct:function(){this.parent(),this.attributes={},this.cid=c()},find:function(){var a={};return this._sync("search",this,a),j.factory("User")},findOne:function(a){return h.factory(this.name).set("id",a).fetch()},_sync:function(a,b){var c=d.Sync[this.sync];c||d.Error.report("No valid sync given, "+this.sync),c("read",this,b)},get:function(a){return this.attributes[a]},has:function(a){return void 0!==this.get(a)},set:function(a,b){return b===this.get(a)?this:(this.attributes[a]=b,this)},setData:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this.set(b,a[b]);return this},unset:function(a){delete this.attributes[a]},clear:function(){},fetch:function(){return this._sync("read"),this},save:function(){},destroy:function(){},url:function(){return this.isNew()?"/"+this.name+"/rest/":"/"+this.name+"/rest/"+this.get(this.idAttribute)},parse:function(a){this.setData(a)},clone:function(){},isNew:function(){return!this.has(this.idAttribute)},isValid:function(){}});h.define=function(a,b){g[a]&&d.Error.report("Model `"+a+"` already declared"),g[a]=PB.Class(h,PB.extend({name:a},b))},h.get=function(a){return g[a]||h.define(a),g[a]},h.factory=function(a){var b=h.get(a);return new b},d.Application.register("Model",function(){return h});var i={},j=PB.Class({construct:function(){}});j.create=function(a,b){i[a]&&d.Error.report("Model `"+a+"` already declared"),i[a]=PB.Class(j,PB.extend({model:h.get(a)},b))},j.factory=function(a){return g[a]||h.define(a),new g[a]},d.Application.register("Collection",function(){return j});var k={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};return d.Sync.RESTful=function(a,b){var c,e={url:b.url(),method:k[a]};c="GET"===e.method?b.parse.bind(b):function(){},new PB.Request(e).on("end",function(a){return a&&a.responseJSON?(c(a.responseJSON),void 0):(d.Error.report("Unexpected JSON response",a.responseText),void 0)}).send()},d.Module.define("BaseView",function(){return PB.Class({construct:function(a,b,c){this.$=a,this.options=b,PB.overwrite(this,c),this.initialize(),this.events&&this._bindEvents()},initialize:function(){},_destruct:function(){this.$.remove(),this.$=null},_bindEvents:function(){var a,b,c,d,e,f=this.events;for(a in f)if(f.hasOwnProperty(a)){if(b=a.split(" "),c=b.shift(),d=b.join(" "),e=f[a],"function"!=typeof this[e]){console.error("View has no method called `"+e+"` with key `"+a+"`");continue}this.$.on(c,d,this[e],this)}}})}),d.Module.define("View",["BaseView"],function(a){function b(a,b){for(var c=0;c<e.length;c++)if(e[c].element[0]===b[0]&&e[c].viewName===a)return e[c];return!1}var c={},e=[];return{define:function(b,e){c[b]&&d.Error.report("Sandwich.View.define::`"+b+"` already defined"),c[b]=PB.Class(a,e)},render:function(){for(var a,f,g,h=d.Application.rootElement.find("[sw-view]"),i=0,j=[];i<h.length;i++)a=h.get(i),f=a.getAttr("sw-view"),c[f]||d.Error.report("Sandwich.View.render::`"+f+"` not defined"),(g=b(f,a))?j.push(g):(g={view:new c[f](a),viewName:f,element:a},e.push(g),j.push(g),g.view.render&&g.view.render());for(i=0;i<e.length;i++)-1===j.indexOf(e[i])&&e[i].view.destroy&&e[i].view.destroy();e=j}}}),d.Application.register("View",function(){return d.Module.getInstance("View")}),d});