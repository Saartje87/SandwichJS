/*!
 * SandwichJS v0.0.1
 * https://github.com/Saartje87/SandwichJS
 *
 * Copyright 2013 Niek Saarberg
 * Licensed MIT
 *
 * Build date 2013-12-04 23:46
 */
!function(a,b,c){this[a]=c(b)}("Sandwich",this,function(){"use strict";function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}function b(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}var c={};c.Error={report:function(a){throw new Error(a)}};var d={};c.Module={define:function(a,b,e){e||(e=b,b=null),"string"!=typeof a&&c.Error.report("Sandwich.Module.define::moduleName must be a string"),"function"!=typeof e&&c.Error.report("Sandwich.Module.define::module declaration must be an object"),d[a]={dependecies:b,module:e,instance:null}},start:function(a){var b,e=[];return a in d||c.Error.report("Sandwich.Module.start::module `"+a+"` not found"),b=d[a],b.instance?b.instance:(b.dependecies&&b.dependecies.forEach(function(a){e.push(c.Module.start(a))}),b.instance=b.module.apply(null,e),"function"==typeof b.instance.onStart&&b.instance.onStart(),b.instance)},getModules:function(){return d}};var e=!1;c.Application={rootElement:"body",_modules:{},create:function(){var a,b=c.Application,d=b._modules,f={};if(e)return c.Error.report("Sandwich.Application.create already initialized");f.rootElement=PB.$(b.rootElement);for(a in d)d.hasOwnProperty(a)&&(f[a]=d[a]());return e=!0,f},register:function(a,b){this._modules[a]=b}},c.Module.define("Router",["Route"],function(a){function b(a){var b;"string"!=typeof a&&(a=window.location.hash),a=d(a),(b=e(a))&&b.callback.apply(b.callback,b.params)}function d(a){return a.replace(/^#?\!?/,"").replace(/^\/\/+/g,"/").replace(/^[\/|\s]+|[\/|\s]+$/g,"")}function e(b){for(var c,d,e=a.all(),f=0;f<e.length;f++)if(c=e[f].matches(b)){d=e[f];break}return d?{route:d.route,callback:d.callback,params:c}:!1}return{onStart:function(){if(!("onhashchange"in window))throw new Error("Browser not supported");PB.$(window).on("hashchange",b),PB.ready(b)},navigate:function(a,c){return a=a.replace(window.location.protocol+"//"+window.location.hostname,""),c&&c.silent?b(a,c):(window.location.hash="!"+d(a),void 0)},when:function(b,e){"string"!=typeof b&&c.Error.report("Router.when::First argument must be a string"),"function"!=typeof e&&c.Error.report("Router.when::Second argument must be a function"),b=d(b),a.add(b,e)}}}),c.Application.register("Router",function(){return c.Module.start("Router")}),c.Module.define("Route",function(){function a(a){for(var b="^",c="",d=0,e=a.length;e>d;d++)switch(c=a[d]){case"/":b+="\\/";break;case":":d=skipGroup(d,a),b+="([a-z0-9.\\s_-]+)";break;case"*":d=skipGroup(d,a),b+="(.*)";break;default:b+=c}return b+="$",b=new RegExp(b,"i"),function(a){var c=a.match(b);return c?Array.prototype.slice.call(c,1):null}}var b=[];return{add:function(c,d){b.unshift({route:c,matches:a(c),callback:d})},all:function(){return b}}});var f={};c.Sync={};var g=function(){this.attributes={},this.cid=b()};g.create=function(a){f[a]&&c.Error.report("Model `"+a+"` already declared"),g.prototype.name=a,f[a]=g},g.factory=function(a){return f[a]||g.create(a),new f[a]},g.prototype={name:null,idAttribute:"id",sync:"RESTful",findOne:function(a){var b=c.Sync[this.sync];b||c.Error.report("No valid sync given, "+this.sync),this.set("id",a),b("read",this)},get:function(a){return this.attributes[a]},has:function(a){return void 0!==this.get(a)},set:function(a,b){return b===this.get(a)?this:(this.attributes[a]=b,this)},setData:function(a){var b;for(b in a)a.hasOwnProperty(b)&&this.set(b,a[b]);return this},unset:function(a){delete this.attributes[a]},clear:function(){},fetch:function(){},save:function(){},destroy:function(){},url:function(){return this.isNew()?"/"+this.name+"/rest/":"/"+this.name+"/rest/"+this.get(this.idAttribute)},parse:function(a){this.set(a)},clone:function(){},isNew:function(){return!this.has(this.idAttribute)},isValid:function(){}},c.Application.register("Model",function(){return g});var h={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};return c.Sync.RESTful=function(a,b){var d,e={url:b.url(),method:h[a]};d="GET"===e.method?b.parse.bind(b):function(){},new PB.Request(e).on("end",function(a){return a&&a.responseJSON?(d(a.responseJSON),void 0):(c.Error.report("Unexpected JSON response",a.responseText),void 0)}).send()},c});